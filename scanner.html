<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner une œuvre - MCN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- 1. Ajout de la librairie de scan QR -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>
    <style> /* Styles alignés avec index.html */
        body { font-family: 'Inter', sans-serif; background: #0a0a0a; color: #ffffff; }
        h1 { font-family: 'Cormorant Garamond', serif; font-weight: 300; }

        /* Styles pour l'interface du scanner */
        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1 / 1;
            margin: 0 auto;
            border-radius: 1.5rem; /* 24px */
            overflow: hidden;
            background: #111; /* Fallback background */
        }

        #qr-reader {
            width: 100%;
            height: 100%;
        }

        #qr-reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }

        /* Viseur personnalisé */
        .viewfinder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* Permet les clics à travers */
        }

        /* Coins du viseur */
        .viewfinder::before, .viewfinder::after {
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            border: 4px solid #d4af37; /* gold */
            border-radius: 0.75rem; /* 12px */
        }
        .viewfinder::before {
            top: 1.25rem; /* 20px */
            left: 1.25rem; /* 20px */
            border-right: none;
            border-bottom: none;
        }
        .viewfinder::after {
            bottom: 20px;
            right: 20px;
            border-left: none;
            border-top: none;
        }

        /* Ligne de scan animée */
        .scan-line {
            position: absolute;
            top: 0;
            left: 5%;
            width: 90%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #d4af37, transparent);
            box-shadow: 0 0 15px 5px rgba(212, 175, 55, 0.5);
            animation: scan-anim 3s ease-in-out infinite;
        }
        @keyframes scan-anim {
            0% { transform: translateY(1.25rem); }
            50% { transform: translateY(calc(100% - 1.25rem)); }
            100% { transform: translateY(1.25rem); }
        }

        /* Styles pour personnaliser l'interface de la librairie html5-qrcode */
        #qr-reader__dashboard_section_csr, #qr-reader__dashboard_section_fsr {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
        }

        #qr-reader__dashboard_section button,
        #html5-qrcode-button-camera-permission {
            background-color: #d4af37; /* gold */
            color: #0a0a0a;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-family: 'Inter', sans-serif;
        }
        #qr-reader__dashboard_section button:hover,
        #html5-qrcode-button-camera-permission:hover {
            background-color: #f4e5a1; /* lighter gold */
        }

        #qr-reader__dashboard_section a {
            color: #d4af37;
            font-size: 0.9rem;
        }

        #html5-qrcode-select-camera {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid #4b5563; /* gray-600 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            width: 100%;
            max-width: 300px;
            text-align: center;
        }
        @keyframes scan-anim {
            0% { transform: translateY(1.25rem); }
            50% { transform: translateY(calc(100% - 1.25rem)); }
            100% { transform: translateY(20px); }
        }
        /* Voice Command Styles */
        #voice-command-overlay {
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(15px);
            transition: opacity 0.3s ease-in-out;
        }
        #voice-command-btn.listening svg {
            animation: pulse-mic 1.5s infinite ease-in-out;
        }
        @keyframes pulse-mic {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        .voice-feedback-wave {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(212, 175, 55, 0.2);
            transform: translate(-50%, -50%) scale(0);
            animation: wave 1.5s infinite ease-out;
        }
        @keyframes wave { to { transform: translate(-50%, -50%) scale(3); opacity: 0; } }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-6">

    <div class="text-center max-w-md w-full">
        <a href="index.html" class="inline-flex items-center mb-8 text-gray-400 hover:text-yellow-600 transition" data-translate-key="back_to_home">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            Retour à l'accueil
        </a>

        <h1 class="text-5xl md:text-6xl font-light mb-4" data-translate-key="scan_title">Scanner une œuvre</h1>
        <p class="text-lg text-gray-400 mb-8 font-light" data-translate-key="scan_subtitle">
            Autorisez l'accès à votre caméra et visez le QR code.
        </p>

        <!-- 2. Conteneur stylisé pour le scanner -->
        <div class="scanner-container">
            <div id="qr-reader"></div>
            <div class="viewfinder">
                <!-- Cet élément sera affiché en cas d'erreur de caméra -->
                <div id="camera-error-overlay" class="absolute inset-0 bg-black/80 flex-col items-center justify-center p-4 text-center hidden">
                    <!-- Le contenu sera injecté par le script -->
                </div>
                <div class="scan-line"></div>
            </div>
        </div>

        <div id="feedback" class="mt-6 text-yellow-500 h-6 transition-opacity"></div>

        <!-- Boutons d'action sous le scanner -->
        <div class="mt-4 flex justify-center items-center gap-4">
            <button id="switch-camera-btn" class="hidden px-5 py-2.5 bg-gray-800 border border-gray-700 rounded-full text-sm font-medium hover:bg-gray-700 transition" data-translate-key="switch_camera_button">
                Changer de caméra
            </button>
            <button onclick="window.location.reload()" class="px-5 py-2.5 bg-yellow-600 hover:bg-yellow-700 text-black font-medium rounded-full transition text-sm" data-translate-key="camera_retry_button">
                Réessayer
            </button>
        </div>
    </div>

    <!-- Voice Command UI -->
    <button id="voice-command-btn" class="fixed bottom-6 right-6 w-16 h-16 bg-yellow-600 rounded-full flex items-center justify-center shadow-lg z-50 hover:bg-yellow-700 transition-transform hover:scale-110">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
        </svg>
    </button>

    <div id="voice-command-overlay" class="hidden fixed inset-0 z-50 flex-col items-center justify-center p-4">
        <div class="relative flex items-center justify-center w-40 h-40">
            <div class="voice-feedback-wave"></div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
        </div>
        <p id="voice-command-feedback" class="mt-8 text-2xl text-white font-light text-center"></p>
        <p id="voice-command-transcript" class="mt-4 text-lg text-gray-400 font-light text-center h-8"></p>
        <button id="close-voice-overlay" class="absolute top-6 right-6 text-white text-4xl font-light">&times;</button>
    </div>

    <!-- 3. Script d'initialisation du scanner -->
    <script>
        const translations = {
            fr: {
                back_to_home: "&larr; Retour à l'accueil",
                scan_title: "Scanner une œuvre",
                scan_subtitle: "Autorisez l'accès à votre caméra et visez le QR code.",
                scan_feedback: "Œuvre trouvée ! Redirection en cours...",
                camera_denied_title: "Accès caméra refusé",
                camera_denied_text: "Pour scanner un QR code, l'accès à la caméra est nécessaire. Veuillez recharger la page et autoriser l'accès.",
                camera_retry_button: "Réessayer",
                switch_camera_button: "Changer de caméra"
            },
            en: {
                back_to_home: "&larr; Back to home",
                scan_title: "Scan an Artwork",
                scan_subtitle: "Allow camera access and aim at the QR code.",
                scan_feedback: "Artwork found! Redirecting...",
                camera_denied_title: "Camera Access Denied",
                camera_denied_text: "To scan a QR code, camera access is required. Please reload the page and grant permission.",
                camera_retry_button: "Retry",
                switch_camera_button: "Switch Camera"
            },
            wo: {
                back_to_home: "&larr; Dellu ci xët wu njëkk",
                scan_title: "Scanal ab Nataal",
                scan_subtitle: "Maye sa camera doxalin te jëmal ko ci QR code bi.",
                scan_feedback: "Gis nañu nataal bi! Yónni nañu la...",
                camera_denied_title: "Nanguwul Camera",
                camera_denied_text: "Ngir man a scanal QR code, laaj na nga maye sa camera. Bësal fii ngir doorat.",
                camera_retry_button: "Doorat",
                switch_camera_button: "Soppi Camera"
            }
        };

        document.addEventListener('DOMContentLoaded', (event) => {
            const feedbackEl = document.getElementById('feedback');
            const cameraErrorOverlay = document.getElementById('camera-error-overlay');
            const switchCameraButton = document.getElementById('switch-camera-btn');
            const lang = localStorage.getItem('mcn-lang') || 'fr';

            let html5QrcodeScanner;
            let currentFacingMode = "environment"; // Commence par la caméra arrière

            function onScanSuccess(decodedText, decodedResult) {
                // `decodedText` contient l'URL ou le texte du QR code.
                console.log(`Code scanné = ${decodedText}`, decodedResult);
                feedbackEl.textContent = translations[lang].scan_feedback;

                // Arrête le scanner
                if (html5QrcodeScanner) {
                    html5QrcodeScanner.clear().catch(err => console.error("Failed to clear scanner on success", err));
                }

                // Redirige l'utilisateur vers l'URL contenue dans le QR code.
                // Pour que cela fonctionne, vos QR codes doivent contenir des liens directs,
                // par exemple : "https://votresite.com/artwork-detail.html?id=1"
                window.location.href = decodedText;
            }

            function onScanFailure(error) {
                // Cette fonction est appelée en continu tant qu'aucun QR code n'est trouvé.
                // On vérifie si l'erreur est due à un refus de permission.
                if (error.includes("NotAllowedError") || error.includes("Permission denied")) {
                    // Arrête toute tentative de scan
                    if (html5QrcodeScanner) {
                        html5QrcodeScanner.clear().catch(err => console.error("Failed to clear scanner on error", err));
                    }

                    // Affiche un message d'erreur personnalisé
                    cameraErrorOverlay.innerHTML = `
                        <h3 class="text-2xl font-semibold text-yellow-500 mb-3">${translations[lang].camera_denied_title}</h3>
                        <p class="text-gray-300 mb-6">${translations[lang].camera_denied_text}</p>
                        <button onclick="window.location.reload()" class="px-6 py-2.5 bg-yellow-600 hover:bg-yellow-700 text-black font-medium rounded-lg transition text-sm">
                            ${translations[lang].camera_retry_button}
                        </button>
                    `;
                    cameraErrorOverlay.classList.remove('hidden');
                    cameraErrorOverlay.classList.add('flex');
                }
            }

            function startScanner(facingMode) {
                // Crée une nouvelle instance du scanner.
                html5QrcodeScanner = new Html5QrcodeScanner(
                    "qr-reader", // ID de l'élément HTML où afficher le scanner
                    { 
                        fps: 10, // Images par seconde pour le scan
                        qrbox: (viewfinderWidth, viewfinderHeight) => {
                            const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                            const qrboxSize = Math.floor(minEdge * 0.8);
                            return { width: qrboxSize, height: qrboxSize };
                        },
                        rememberLastUsedCamera: false, // Important pour le changement manuel
                        facingMode: facingMode
                    },
                    /* verbose= */ false);
                
                // Lance le rendu du scanner.
                html5QrcodeScanner.render(onScanSuccess, onScanFailure);
            }

            // Vérifie s'il y a plusieurs caméras et affiche le bouton si c'est le cas
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length > 1) {
                    switchCameraButton.classList.remove('hidden');
                }
            }).catch(err => {
                console.error("Impossible d'obtenir la liste des caméras.", err);
            });

            // Logique du bouton de changement de caméra
            switchCameraButton.addEventListener('click', () => {
                if (html5QrcodeScanner) {
                    html5QrcodeScanner.clear()
                        .then(() => {
                            currentFacingMode = (currentFacingMode === "environment") ? "user" : "environment";
                            startScanner(currentFacingMode);
                        })
                        .catch(err => {
                            console.error("Erreur lors du nettoyage du scanner pour changer de caméra", err);
                        });
                }
            });

            // Lancement initial du scanner
            startScanner(currentFacingMode);

            // Appliquer les traductions
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                if (translations[lang] && translations[lang][key]) {
                    element.innerHTML = translations[lang][key];
                }
            });

            // --- Voice Command Logic ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.warn("La reconnaissance vocale n'est pas supportée par ce navigateur.");
                document.getElementById('voice-command-btn').style.display = 'none';
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;

            const voiceBtn = document.getElementById('voice-command-btn');
            const voiceOverlay = document.getElementById('voice-command-overlay');
            const closeOverlayBtn = document.getElementById('close-voice-overlay');
            const feedbackElVoice = document.getElementById('voice-command-feedback');
            const transcriptEl = document.getElementById('voice-command-transcript');

            const updateLang = () => {
                const currentLang = localStorage.getItem('mcn-lang') || 'fr';
                recognition.lang = currentLang === 'wo' ? 'fr-FR' : (currentLang + '-FR'); // Wolof n'est pas supporté, on utilise le français
                feedbackElVoice.textContent = {
                    fr: "Je vous écoute...",
                    en: "I'm listening...",
                    wo: "Ma ngi lay déglu..."
                }[currentLang];
            };

            voiceBtn.addEventListener('click', () => {
                updateLang();
                voiceOverlay.classList.remove('hidden');
                voiceOverlay.classList.add('flex');
                voiceBtn.classList.add('listening');
                transcriptEl.textContent = '';
                try {
                    recognition.start();
                } catch (e) {
                    console.error("Erreur au démarrage de la reconnaissance vocale:", e);
                    stopListening();
                }
            });

            const stopListening = () => {
                voiceOverlay.classList.add('hidden');
                voiceOverlay.classList.remove('flex');
                voiceBtn.classList.remove('listening');
                recognition.stop();
            };

            closeOverlayBtn.addEventListener('click', stopListening);

            recognition.onresult = (event) => {
                let transcript = Array.from(event.results)
                    .map(result => result[0])
                    .map(result => result.transcript)
                    .join('');

                transcriptEl.textContent = transcript;

                if (event.results[0].isFinal) {
                    handleVoiceCommand(transcript.toLowerCase().trim());
                    stopListening();
                }
            };

            recognition.onerror = (event) => {
                console.error("Erreur de reconnaissance vocale:", event.error);
                stopListening();
            };

            recognition.onend = () => {
                stopListening();
            };

            function handleVoiceCommand(command) {
                console.log("Commande vocale reçue:", command);
                const lang = localStorage.getItem('mcn-lang') || 'fr';
 
                const pageKeywords = {
                    fr: { 'accueil': 'index.html', 'galerie': 'gallery.html', 'scanner': 'scanner.html', 'expérience': 'index.html#experience', 'à propos': 'index.html#about' },
                    en: { 'home': 'index.html', 'gallery': 'gallery.html', 'scanner': 'scanner.html', 'experience': 'index.html#experience', 'about': 'index.html#about' },
                    wo: { 'accueil': 'index.html', 'galerie': 'gallery.html', 'scanner': 'scanner.html' }
                };
 
                for (const target in pageKeywords[lang]) { if (command.includes(target)) { window.location.href = pageKeywords[lang][target]; return; } }
            }
        });
    </script>

</body>
</html>