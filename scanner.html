<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner une œuvre - MCN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- 1. Ajout de la librairie de scan QR -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0a0a0a; color: #ffffff; }
        h1 { font-family: 'Cormorant Garamond', serif; font-weight: 300; }

        /* Styles pour l'interface du scanner */
        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1 / 1;
            margin: 0 auto;
            border-radius: 24px;
            overflow: hidden;
            background: #111; /* Fallback background */
        }

        #qr-reader {
            width: 100%;
            height: 100%;
        }

        #qr-reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }

        /* Viseur personnalisé */
        .viewfinder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* Permet les clics à travers */
        }

        /* Coins du viseur */
        .viewfinder::before, .viewfinder::after {
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            border: 4px solid #d4af37;
            border-radius: 12px;
        }
        .viewfinder::before {
            top: 20px;
            left: 20px;
            border-right: none;
            border-bottom: none;
        }
        .viewfinder::after {
            bottom: 20px;
            right: 20px;
            border-left: none;
            border-top: none;
        }

        /* Ligne de scan animée */
        .scan-line {
            position: absolute;
            top: 0;
            left: 5%;
            width: 90%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #d4af37, transparent);
            box-shadow: 0 0 15px #d4af37;
            animation: scan-anim 3s ease-in-out infinite;
        }
        @keyframes scan-anim {
            0% { transform: translateY(20px); }
            50% { transform: translateY(calc(400px - 20px)); } /* 400px = max-width */
            100% { transform: translateY(20px); }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-6">

    <div class="text-center max-w-md w-full">
        <a href="index.html" class="inline-block mb-8 text-gray-400 hover:text-white transition" data-translate-key="back_to_home">&larr; Retour à l'accueil</a>

        <h1 class="text-4xl mb-4" data-translate-key="scan_title">Scanner une œuvre</h1>
        <p class="text-gray-400 mb-8" data-translate-key="scan_subtitle">
            Autorisez l'accès à votre caméra et visez le QR code.
        </p>

        <!-- 2. Conteneur stylisé pour le scanner -->
        <div class="scanner-container">
            <div id="qr-reader"></div>
            <div class="viewfinder">
                <div class="scan-line"></div>
            </div>
        </div>

        <div id="feedback" class="mt-6 text-yellow-600 h-6 transition-opacity"></div>
    </div>

    <!-- 3. Script d'initialisation du scanner -->
    <script>
        const translations = {
            fr: {
                back_to_home: "&larr; Retour à l'accueil",
                scan_title: "Scanner une œuvre",
                scan_subtitle: "Autorisez l'accès à votre caméra et visez le QR code.",
                scan_feedback: "Œuvre trouvée ! Redirection en cours..."
            },
            en: {
                back_to_home: "&larr; Back to home",
                scan_title: "Scan an Artwork",
                scan_subtitle: "Allow camera access and aim at the QR code.",
                scan_feedback: "Artwork found! Redirecting..."
            },
            wo: {
                back_to_home: "&larr; Dellu ci xët wu njëkk",
                scan_title: "Scanal ab Nataal",
                scan_subtitle: "Maye sa camera doxalin te jëmal ko ci QR code bi.",
                scan_feedback: "Gis nañu nataal bi! Yónni nañu la..."
            }
        };

        document.addEventListener('DOMContentLoaded', (event) => {
            const feedbackEl = document.getElementById('feedback');
            const lang = localStorage.getItem('mcn-lang') || 'fr';

            function onScanSuccess(decodedText, decodedResult) {
                // `decodedText` contient l'URL ou le texte du QR code.
                console.log(`Code scanné = ${decodedText}`, decodedResult);
                feedbackEl.textContent = translations[lang].scan_feedback;

                // Arrête le scanner pour ne pas continuer à scanner en arrière-plan
                html5QrcodeScanner.clear();

                // Redirige l'utilisateur vers l'URL contenue dans le QR code.
                // Pour que cela fonctionne, vos QR codes doivent contenir des liens directs,
                // par exemple : "https://votresite.com/artwork-detail.html?id=1"
                window.location.href = decodedText;
            }

            function onScanFailure(error) {
                // Cette fonction est appelée en continu tant qu'aucun QR code n'est trouvé.
                // Il est préférable de ne rien afficher pour ne pas surcharger l'interface.
                // console.warn(`Erreur de scan = ${error}`);
            }

            // Crée une nouvelle instance du scanner.
            const html5QrcodeScanner = new Html5QrcodeScanner(
                "qr-reader", // ID de l'élément HTML où afficher le scanner
                { 
                    fps: 10, // Images par seconde pour le scan
                    qrbox: (viewfinderWidth, viewfinderHeight) => {
                        // On définit une boîte de scan qui correspond à 80% de la plus petite dimension
                        const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                        const qrboxSize = Math.floor(minEdge * 0.8);
                        return { width: qrboxSize, height: qrboxSize };
                    },
                    rememberLastUsedCamera: true, // Se souvenir de la dernière caméra utilisée
                    // Ajout pour privilégier la caméra arrière (téléphone)
                    facingMode: "environment"
                },
                /* verbose= */ false); // Mettre à `true` pour plus de logs de débogage
            
            // Lance le rendu du scanner.
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);

            // Appliquer les traductions
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                if (translations[lang] && translations[lang][key]) {
                    element.innerHTML = translations[lang][key];
                }
            });
        });
    </script>

</body>
</html>